<#--
* description: 用户/角色组件权限分配界面
* version: 1.0
* -->
<#include "../include/header.html">
<body>
<div id="content-container">
    <div id="page-content">
        <div>
            <div style="clear:both">
                <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                    <span class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;" data-bind="click:createFunction"><@spring.message "hap.new"/></span>
                    <span class="btn btn-success"  style="float:left;margin-right:5px;" data-bind="click:saveFunction"><@spring.message "hap.save"/></span>
                    <span class="btn btn-default" data-bind="click:cancelFunction" style="float:left;margin-right:5px;"><@spring.message "hap.cancel"/></span>
                </div>
                <div style="clear:both">
                    <div id="assignComponentListGrid" style="clear: both"></div>
                </div>
            </div>
        </div>
        <div id="componentSelectWindow"></div>
        <div id="authColumnWin_divId"></div>
        <script type="text/x-kendo-template" id="componentSelectWin_template">
            <div id="details-container">
                <div id="selectComponent-content">
                    <div class="pull-right" id="themesNotInThemeGroup_form" style="padding-bottom:10px;">
                        <input type="text"   style="float:left;width:150px;margin-right:5px;" placeholder='<@spring.message "hap_extend.op_permission.grid_title.name"/>' data-bind="value:model.componentName" class="k-textbox">
                        <input type="text"   style="float:left;width:150px;margin-right:5px;" placeholder='<@spring.message "hap_extend.op_permission.grid_title.description"/>' data-bind="value:model.description" class="k-textbox">
                        <span class="btn btn-primary" style="float:left;width:70px;margin-right:5px;" data-bind="click:queryFunction" type="submit"><@spring.message "hap.query"/></span>
                        <span class="btn btn-default" style="float:left;width:70px"  data-bind="click:resetForm" type="button"><@spring.message "hap.reset"/></span>
                        <div style="clear:both"></div>
                    </div>
                    <div style="clear:both">
                        <div id="componentSelect_grid" style="clear: both"></div>
                    </div>
                </div>
            </div>
        </script>
    </div>
</div>
<script type="text/javascript">
    var baseUrl = "${base.contextPath}/hap_extend/operation_permission/cpn_assign/";
    var assignedCpn_data;
    //获取传递过来的数据
    var resourceId_param = "${RequestParameters.resourceId}";
    var assignId_param = "${RequestParameters.assignId}";
    var componentSelectWin = $("#componentSelectWindow")
        .kendoWindow({
            title: 'SELECT COMPONENT',
            modal: true,
            visible: false,
            resizable: true,
            actions : [ "Maximize", "Minimize", "Close"],
            width: 600,
            height:400
        }).data("kendoWindow");
    var componentSelectWinTemplate = kendo.template($("#componentSelectWin_template").html());

    var viewModel = kendo.observable({
        model : {
            resourceId:resourceId_param,
            assignId:assignId_param
        },
        createFunction: function(){
            $('#assignComponentListGrid').data('kendoGrid').addRow();
        },
        saveFunction: function(){
            $('#assignComponentListGrid').data('kendoGrid').dataSource.sync();
        },
        cancelFunction: function(e){
            $('#assignComponentListGrid').data('kendoGrid').cancelChanges();
        },
        queryFunction: function(e) {
            $('#assignComponentListGrid').data('kendoGrid').dataSource.page(1);
        },
        resetForm : function(e) {
            var formData = viewModel.model.toJSON();
            for ( var k in formData) {
                if(k==="assignId" || k==="resourceId"){
                    continue;
                }else {
                    viewModel.model.set(k, null);
                }
            }
        }
    });

    kendo.bind($('#toolbar-btn'), viewModel);
    kendo.bind($('#page-content'),viewModel);

    assignedCpn_data = new kendo.data.DataSource({
        transport: {
            read: {
                url: baseUrl+"query",
                type: "POST",
                dataType: "json"
            },
            update: {
                url: baseUrl + "update",
                type : 'POST',
                dataType: "json",
                contentType:"application/json"
            },
            create: {
                url: baseUrl+'submit',
                type : 'POST',
                dataType: "json",
                contentType:"application/json"
            },
            destroy:{
                url: baseUrl+'remove',
                type : 'POST',
                dataType: "json",
                contentType:"application/json"
            },
            parameterMap: function(options, operation) {
                if (operation !== "read" && options.models) {
                    return kendo.stringify(Hap.prepareSubmitParameter(options, operation));
                } else if (operation === "read") {
                    return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                }
            }
        },
        batch: true,
        serverPaging : true,
        pageSize: 10,
        schema: {
            data:'rows',
            total:'total',
            model: {
                id: 'cpnAssignId',
                fields: {
                    assignId: { type: 'int',defaultValue:assignId_param },
                    componentId: { type: 'int',validation: { required: true, nullable: false } },
                    componentName: { type: 'string'},
                    display:{defaultValue:'Y',checkedValue:'Y',uncheckedValue:'N',type: 'boolean'},
                    require:{defaultValue:'N',checkedValue:'Y',uncheckedValue:'N',type: 'boolean'},
                    readonly:{defaultValue:'N',checkedValue:'Y',uncheckedValue:'N',type: 'boolean'},
                    disable:{defaultValue:'N',checkedValue:'Y',uncheckedValue:'N',type: 'boolean'},
                    enableFlag:{defaultValue:'Y',checkedValue:'Y',uncheckedValue:'N',type: 'boolean'},
                    description: { type: 'string' }
                }
            }
        }
    });

    var grid = $("#assignComponentListGrid").kendoGrid({
        dataSource: assignedCpn_data,
        resizable: true,
        selectable: "multiple",
        scrollable: true,
        pageable: {
            pageSizes: [10, 20, 50, 100],
            refresh: true,
            buttonCount: 10
        },
        columns:
            [
                {
                    'field': 'componentId',
                    'title':'<@spring.message "hap_extend.op_permission.grid_title.name"/>',
                    'width': 100,
                    template: function (dataItem) {
                        return dataItem['componentName'] || ''
                    },
                    editor: function (container, options) {
                        $('<span class="k-textbox k-space-right" style="width: 100%;"><input readonly="readonly" type="text" name="' + options.field + '" class="k-input k-textbox"/><a href="#" onclick="showCpnLov(event)" class="k-icon k-i-search">&nbsp;</a></span>')
                            .appendTo(container);

                    }
                },
                {
                    'field':'description',
                    'title': '<@spring.message "hap_extend.op_permission.grid_title.description"/>',
                    'width':100
                },
                {
                    attributes: {style: "text-align:center;"},
                    'field': 'display',
                    'title':'<@spring.message "hap_extend.op_permission.assign_cpn.title_display"/>',
                    'width': 30
                },
                {
                    attributes: {style: "text-align:center;"},
                    'field': 'require',
                    'title':'<@spring.message "hap_extend.op_permission.assign_cpn.title_require"/>',
                    'width': 30
                },
                {
                    attributes: {style: "text-align:center;"},
                    'field': 'readonly',
                    'title':'<@spring.message "hap_extend.op_permission.assign_cpn.title_readonly"/>',
                    'width': 30
                },
                {
                    attributes: {style: "text-align:center;"},
                    'field': 'disable',
                    'title':'<@spring.message "hap_extend.op_permission.assign_cpn.title_disable"/>',
                    'width': 30
                },
                {
                    attributes: {style: "text-align:center;"},
                    'field': 'enableFlag',
                    'title':'<@spring.message "hap_extend.data_permission.rule.title_rule_enable"/>',
                    'width': 30
                },
                {
                    attributes: {style: "text-align:center;padding:0px"},
                    'field': '',
                    'title':'<@spring.message "hap_extend.data_permission.grid_title.column_auth"/>',
                    'width': 30,
                    template: function (rowData) {
                        if(!!rowData["cpnAssignId"] && !!rowData["componentId"] && "grid"===rowData["componentType"]){
                            parameter1 = rowData["cpnAssignId"];
                            parameter2 = rowData["componentId"];
                            return '<a class="btn btn-success" onclick="showAuthColumnWin(parameter1,parameter2)"><@spring.message "hap_extend.data_permission.grid_title.column_auth"/></a>';
                        }
                        return '<a class="btn btn-success" disabled="disabled"><@spring.message "hap_extend.data_permission.grid_title.column_auth"/></a>';
                    }
                },
                {
                    attributes: {style: "text-align:center;padding:0px"},
                    title: '<@spring.message "hap_extend.op_permission.grid_title.description"/>',
                    command : [{
                        name:'remove',
                        template : function (rowData) {
                            return '<a class="btn btn-danger k-grid-remove"><@spring.message "hap.delete"/></a>';
                        },
                        click: function(e){
                            var th = this;
                            e.preventDefault();
                            kendo.ui.showConfirmDialog({
                                title:$l('hap.tip.info'),
                                message: $l('hap.tip.delete_confirm')
                            }).done(function(event){
                                if(event.button == 'OK'){
                                    var data = th.dataItem($(e.target).closest("tr"));
                                    th.dataSource.remove(data);
                                    th.dataSource.sync()
                                }
                            })
                        }
                    }],
                    width:30
                }
            ],
        editable: true
    });

    Hap.autoResizeGrid("#assignComponentListGrid");


    function showCpnLov(event) {
        var rowData = $("#assignComponentListGrid").data("kendoGrid").dataItem($(event.target).closest("tr"));
        componentSelectWin.content(componentSelectWinTemplate);
        componentSelectWin.center().open();
        var componentSelect_viewModel = kendo.observable({
            model : {
                componentName:'',
                description:'',
                resourceId:resourceId_param
            },
            queryFunction: function(e) {
                $('#componentSelect_grid').data('kendoGrid').dataSource.page(1);
            },
            resetForm : function(e) {
                var formData = componentSelect_viewModel.model.toJSON();
                for ( var k in formData) {
                    if(k==="resourceId"){
                        continue;
                    }else {
                        componentSelect_viewModel.model.set(k, null);
                    }
                }
            }
        });
        var cpnToSelect_data = new kendo.data.DataSource({
            transport: {
                read:  {
                    url: "${base.contextPath}/hap_extend/operation_permission/cpn/query",
                    type : 'POST',
                    dataType: "json"
                },
                parameterMap: function(options, operation) {
                    if (operation === "read") {
                        var model = componentSelect_viewModel.model;
                        if(!model.componentName){
                            model.componentName='';
                        }
                        if(!model.description){
                            model.description='';
                        }

                        var map = {resourceId:resourceId_param,componentName:model.componentName,description: model.description};
                        if (options.page)
                            map.page = options.page;
                        if (options.pageSize)
                            map.pageSize = options.pageSize;
                        for(var k in map){
                            if(map[k]==='')delete map[k]
                        }
                        return map;
                    }
                }
            },
            batch: true,
            serverPaging : true,
            pageSize: 10,
            schema: {
                data:'rows',
                total:'total',
                model: {
                    id: 'componentId',
                    fields: {
                        componentName: {
                            type: 'string'
                        },
                        level:{type:'string'},
                        componentType:{type:'string'},
                        description:{type:'string'}
                    }
                }
            }
        });
        $("#componentSelect_grid").kendoGrid({
            dataSource: cpnToSelect_data,
            resizable: true,
            selectable: "multiple",
            scrollable: true,
            columnMenu: true,
            reorderable: true,
            pageable: {
                pageSizes:[10, 20, 50, 100],
                refresh:true,
                buttonCount:10
            },
            columns:
                [
                    {
                        'field': 'componentName',
                        'title': '<@spring.message "hap_extend.op_permission.grid_title.name"/>',
                        'width': "50px"
                    },
                    {
                        'field': 'level',
                        'title': '<@spring.message "level"/>',
                        'width': "50px"
                    },
                    {
                        'field': 'componentType',
                        'title': '<@spring.message "componentType"/>',
                        'width': "50px"
                    },
                    {
                        'field': 'description',
                        'title': '<@spring.message "hap_extend.op_permission.grid_title.description"/>',
                        'width': "100px"
                    }
                ],
            editable: false
        });
        $("#componentSelect_grid").on("dblclick", "tr", function (e) {
            e.preventDefault();
            var firstRow = $("#componentSelect_grid").data("kendoGrid").selectedDataItems()[0];
            rowData.set("componentId",firstRow.componentId);
            rowData.set("componentName",firstRow.componentName);
            rowData.set("componentType",firstRow.componentType);
            componentSelectWin.close();
        });
        kendo.bind($('#selectComponent-content'),componentSelect_viewModel);
    }

    function showAuthColumnWin(param_cpnAssignId, param_componentId) {
        $("#authColumnWin_divId").kendoWindow(
            {
                actions : ["Close" ],
                width : 800,
                height : 450,
                title : '<@spring.message "hap_extend.data_permission.grid_title.column_auth"/>',
                visible : false,
                iframe : true,
                modal: true,
                content : 'assign_gridColumn.html?componentId='
                + param_componentId+"&cpnAssignId="+param_cpnAssignId
            }).data("kendoWindow").center().open();
    }


</script>

</body>
</html>