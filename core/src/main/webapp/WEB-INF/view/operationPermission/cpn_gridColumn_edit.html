<#--
    * description: grid组件详细设置界面(主要设置列的不可编辑、列隐藏)
    * version: 1.0
    * -->
<#include "../include/header.html">
<body>
<div id="content-container">
    <div id="page-content">
        <div class="panel">
            <form class="form-horizontal">
                <div class="panel-body col-sm-offset-0">
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label style="width: 20%"><@spring.message "hap_extend.op_permission.name"/></label>
                            <input type="text" style="width:70%" data-bind="value:model.name">
                        </div>
                    </div>
                </div>
                <div class="panel-footer text-right">
                    <span class="btn btn-success" data-bind="click:queryFunction" type="submit"><@spring.message "hap.query"/></span>
                    <span class="btn btn-default" data-bind="click:resetFunction" type="button"><@spring.message "hap.reset"/></span>
                </div>
            </form>
        </div>
        <div class="panel">
            <div class="panel-body">
                <div style="clear:both">
                    <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                        <span class="btn btn-primary" data-bind="click:createFunction" style="float:left;margin-right:5px;"><@spring.message "hap.new"/></span>
                        <span class="btn btn-success" data-bind="click:saveFunction" style="float:left;margin-right:5px;"><@spring.message "hap.save"/></span>
                        <span class="btn btn-default" data-bind="click:cancelFunction" style="float:left;margin-right:5px;"><@spring.message "hap.cancel"/></span>
                    </div>
                    <div style="clear:both">
                        <div id="gridColumns_grid" style="clear:both"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var baseRuleUrl = "${base.contextPath}/hap_extend/operation_permission/grid_column/";
    //获取传递过来的数据
    var componentId_param = "${RequestParameters.componentId_param}";

    var viewModel = kendo.observable({
        model:{name:'',componentId:componentId_param},
        createFunction: function(){
            $('#gridColumns_grid').data('kendoGrid').addRow();
        },
        saveFunction: function(){
            $('#gridColumns_grid').data('kendoGrid').saveChanges();
        },
        cancelFunction: function(e){
            $('#gridColumns_grid').data('kendoGrid').cancelChanges();
        },
        queryFunction: function(e) {
            $('#gridColumns_grid').data('kendoGrid').dataSource.read();
        },
        resetFunction: function (e) {
            var formData = viewModel.model.toJSON();
            for (var k in formData) {
                if(!(k === "componentId")){
                    viewModel.model.set(k, null);
                }
            }
        }
    });
    kendo.bind($('#toolbar-btn'), viewModel);
    kendo.bind($('#page-content'),viewModel);


    //Grid行中的删除事件处理函数
    //参数：grid_div_id是kendoGrid那个div的id值;e:click事件
    function grid_del_btn_click(grid_div_id,e){
        e.preventDefault();
        kendo.ui.showConfirmDialog({
            title:$l('hap.tip.info'),
            message: $l('hap.tip.delete_confirm')
        }).done(function(event){
            if(event.button == 'OK'){
                var data = $("#"+grid_div_id).data("kendoGrid").dataItem($(e.target).closest("tr"));
                $("#"+grid_div_id).data("kendoGrid").dataSource.remove(data);
                $("#"+grid_div_id).data('kendoGrid').saveChanges();
            }
        });
    }

    $("#gridColumns_grid").kendoGrid({
        dataSource: new kendo.data.DataSource({
            transport: {
                read: {
                    url: baseRuleUrl+"query",
                    type: "POST",
                    dataType: "json"
                },
                update: {
                    url: baseRuleUrl + "update",
                    type : 'POST',
                    dataType: "json",
                    contentType:"application/json"
                },
                create: {
                    url: baseRuleUrl+'submit',
                    type : 'POST',
                    dataType: "json",
                    contentType:"application/json"
                },
                destroy:{
                    url: baseRuleUrl+'remove',
                    type : 'POST',
                    dataType: "json",
                    contentType:"application/json"
                },
                parameterMap: function(options, operation) {
                    //封装请求参数
                    if (operation !== "read" && options.models) {
                        return kendo.stringify(Hap.prepareSubmitParameter(options, operation));
                    } else if (operation === "read") {
                        return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                    }
                }
            },
            batch: true,
            serverPaging: true,
            pageSize: 10,
            schema: {
                data: 'rows',
                total: 'total',
                model: {
                    id: "columnId",
                    fields: {
                        componentId:{type: 'number',defaultValue:componentId_param},
                        name:{type: 'string',validation: { required: true }},
                        index:{type: 'number',min: 0,validation: { required: true }}
                    }
                }
            }
        }),
        resizable: true,
        selectable: "multiple",
        scrollable: true,
        editable  : true,
        pageable: {
            pageSizes: [10, 20, 50, 100],
            refresh: true,
            buttonCount: 10
        },
        columns: [
            {
                field: "name",
                title: '<@spring.message "hap_extend.op_permission.grid_title.name"/>',
                width: 80
            },
            {
                field: "index",
                title: '<@spring.message "hap_extend.op_permission.grid_title.index"/>',
                width: 40
            }
        ]
    });
    Hap.autoResizeGrid("#gridColumns_grid");

</script>
<div>
</body>
</html>