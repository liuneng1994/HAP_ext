<#--
    * description: 用户/角色js分配界面
    * version: 1.0
    * -->
<#include "../include/header.html">
<body>
<div>
    <div id="content-container">
        <div id="theme-content">
            <div id="page-content" style="clear:both">
                <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                    <span class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;" data-bind="click:createFunction"><@spring.message "hap.new"/></span>
                    <span class="btn btn-success"  style="float:left;margin-right:5px;" data-bind="click:saveFunction"><@spring.message "hap.save"/></span>
                    <span class="btn btn-default" data-bind="click:cancelFunction" style="float:left;margin-right:5px;"><@spring.message "hap.cancel"/></span>
                </div>
                <div style="clear:both">
                    <div id="themeListGrid" style="clear: both"></div>
                </div>
                <div id="levelWindow">
                    <div style="clear:both" >
                        <div id="levelGrid" style="clear:both"></div>
                    </div>
                </div>
                <div id="assignJsWin_divId"></div>
            </div>
        </div>
        <div id="selectThemeDetails"></div>
    </div>
    <script type="text/javascript">
        var baseUrl = "${base.contextPath}/hap_extend/operation_permission/permission_type/";
        var themes_data;
        //获取传递过来的数据
        var resourceId_param = "${RequestParameters.resourceId_param}";
        var viewModel = kendo.observable({
            model : {
                resourceId:resourceId_param
            },
            createFunction: function(){
                $('#themeListGrid').data('kendoGrid').addRow();
            },
            saveFunction: function(){
                $('#themeListGrid').data('kendoGrid').dataSource.sync();
            },
            cancelFunction: function(e){
                $('#themeListGrid').data('kendoGrid').cancelChanges();
            },
            queryFunction: function(e) {
                $('#themeListGrid').data('kendoGrid').dataSource.page(1);
            },
            resetForm : function(e) {
                var formData = viewModel.model.toJSON();
                for ( var k in formData) {
                    if(k==="resourceId"){
                        continue;
                    }else {
                        viewModel.model.set(k, null);
                    }
                }
            }
        });
        kendo.bind($('#toolbar-btn'), viewModel);

        //关闭层级值窗口
        function closeWin(){
            //关闭该window
            $("#levelWindow").data("kendoWindow").close();
        }
        //保存层级值
        function save(e){
            var row = levelGrid.select();
            var data = levelGrid.dataItem(row);

            parentData.set('assignValue' , data.assignValue);
            parentData.set('assignValueName' , data.assignValueName);
            closeWin();
        }

        $(document).ready(function () {
            themes_data = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: baseUrl+"query",
                        type: "POST",
                        dataType: "json"
                    },
                    update: {
                        url: baseUrl + "update",
                        type : 'POST',
                        dataType: "json",
                        contentType:"application/json"
                    },
                    create: {
                        url: baseUrl+'submit',
                        type : 'POST',
                        dataType: "json",
                        contentType:"application/json"
                    },
                    destroy:{
                        url: baseUrl+'remove',
                        type : 'POST',
                        dataType: "json",
                        contentType:"application/json"
                    },
                    parameterMap: function(options, operation) {
                        if (operation !== "read" && options.models) {
                            return kendo.stringify(Hap.prepareSubmitParameter(options, operation));
                        } else if (operation === "read") {
                            return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                        }
                    }
                },
                batch: true,
                serverPaging : true,
                pageSize: 10,
                schema: {
                    data:'rows',
                    total:'total',
                    model: {
                        id: 'assignId',
                        fields: {
                            resourceId: { type: 'int',defaultValue:resourceId_param },
                            assignType: { type: 'string',validation: { required: true, nullable: false } },
                            assignValue: { type: 'int',validation: { required: true, nullable: false } },
                            assignValueName: { type: 'string' },
                            enableFlag:{defaultValue:'Y',checkedValue:'Y',uncheckedValue:'N',type: 'boolean'},
                            description: { type: 'string' }
                        }
                    }
                }
            });

            //层级类型：用户/角色
            var nowLocal = '${base.locale}';
            var level_dataSource = [];

            if(nowLocal=='en_GB'){
                level_dataSource = [
                    {"meaning": "USER", "value": "USER"},
                    {"meaning": "ROLE", "value": "ROLE"},
                    {"meaning": "GLOBAL", "value": "GLOBAL"}
                ];
            }
            if(nowLocal=='zh_CN'){
                level_dataSource = [
                    {"meaning": "用户", "value": "USER"},
                    {"meaning": "角色", "value": "ROLE"},
                    {"meaning": "全局", "value": "GLOBAL"}
                ];
            }
            function handleQueryUserResult(data) {
                if(data && data["rows"]){
                    $.each(data["rows"],function (key, value) {
                        value["assignValueName"] = value["userName"];
                        value["assignValue"] = value["userId"];
                    });
                }
                return data;
            }
            function handleQueryRoleResult(data) {
                if(data && data["rows"]){
                    $.each(data["rows"],function (key, value) {
                        value["assignValueName"] = value["roleName"];
                        value["assignValue"] = value["roleId"];
                    });
                }
                return data;
            }
            var assignValue_global;
            if(nowLocal=='zh_CN'){
                assignValue_global={rows:[{assignValueName:"全局",assignValue:10001}],total:1};
            }
            if(nowLocal=='en_GB'){
                assignValue_global={rows:[{assignValueName:"GLOBAL",assignValue:10001}],total:1};
            }
            var userDataSource = new kendo.data.DataSource({
                transport: {
                    read:  function (args) {
                        var options = args.data;
                        var map = {};
                        if (options.page)
                            map.page = options.page;
                        if (options.pageSize)
                            map.pageSize = options.pageSize;
                        for(var k in map){
                            if(map[k]==='')delete map[k]
                        }
                        $.ajax({
                            type: 'POST',
                            url: "${base.contextPath}/sys/user/query" ,
                            data: map,
                            success: function (data) {
                                args.success(handleQueryUserResult(data));
                            },
                            async:true,
                            dataType: "json"
                        });
                    }
                },
                serverPaging : true,
                pageSize: 10,
                schema: {
                    data:'rows',
                    total:'total',
                    model: {
                        id: 'userId',
                        fields: {
                            userName: { type: 'string' }
                        }
                    }
                }
            });
            var roleDataSource = new kendo.data.DataSource({
                transport: {
                    read:  function (args) {
                        var options = args.data;
                        var map = {};
                        if (options.page)
                            map.page = options.page;
                        if (options.pageSize)
                            map.pageSize = options.pageSize;
                        for(var k in map){
                            if(map[k]==='')delete map[k]
                        }
                        $.ajax({
                            type: 'POST',
                            url: "${base.contextPath}/sys/role/query" ,
                            data: map,
                            success: function (data) {
                                args.success(handleQueryRoleResult(data));
                            },
                            async:true,
                            dataType: "json"
                        });
                    }
                },
                batch: true,
                serverPaging : true,
                pageSize: 10,
                schema: {
                    data:'rows',
                    total:'total',
                    model: {
                        id: 'roleId',
                        fields: {
                            roleName: { type: 'string' }
                        }
                    }
                }
            });
            var globalDataSource = new kendo.data.DataSource({
                transport: {
                    read:  function (args) {
                        args.success(assignValue_global);
                    }
                },
                serverPaging : true,
                pageSize: 10,
                schema: {
                    data:'rows',
                    total:'total',
                    model: {
                        id: 'assignValue',
                        fields: {
                            assignValueName: { type: 'string' }
                        }
                    }
                }
            });

            $('#levelGrid').dblclick(function(e){
                save();
            });
            //选择层级值的window
            $("#levelWindow").kendoWindow({
                actions: [ "Maximize", "Minimize", "Close"],
                width: 500,
                height: 400,
                title: '<@spring.message "hap.tip.info"/>',
                visible: false,
                iframe: false,
                scrollable: false,
                modal : true

            });
            levelGrid = $("#levelGrid").kendoGrid({
                navigatable: false,
                height     : '55%',
                resizable  : true,
                scrollable : true,
                selectable: "row",
                pageable   : {
                    pageSizes  : [10, 15],
                    refresh    : true,
                    buttonCount: 10
                },
                toolbar: [{
                    template:' <span class="btn btn-success " onclick="save()" type="submit"><@spring.message "hap.save"/></span>'
                },{
                    template:'<span class="btn btn-default "  onclick="closeWin()" type="button"><@spring.message "hap.cancel"/></span>'
                }
                ],
                columns: [
                    {
                        field: "assignValueName",
                        title: '<@spring.message "hap_extend.data_permission.rule.title_name"/>',
                        width: 120
                    }, {
                        field: "assignValue",
                        title: '<@spring.message "hap_extend.data_permission.rule.title_value"/>',
                        width: 120
                    }],
                editable: false
            }).data("kendoGrid");

            var grid = $("#themeListGrid").kendoGrid({
                dataSource: themes_data,
                resizable: true,
                selectable: "multiple",
                scrollable: true,
                pageable: {
                    pageSizes: [10, 20, 50, 100],
                    refresh: true,
                    buttonCount: 10
                },
                columns:
                [
                    {
                        'field': 'assignType',
                        'title':'<@spring.message "hap_extend.data_permission.rule.title_level_name"/>',
                        'width': 50,
                        template: function (dataItem) {
                            return Hap.getCodeMeaning(level_dataSource, dataItem.assignType)
                        },
                        editor: function (container, options) {
                            $('<input required name="' + options.field + '"/>')
                            .appendTo(container)
                            .kendoDropDownList({
                                dataTextField : "meaning",
                                dataValueField: "value",
                                dataSource    : level_dataSource
                            });
                        }
                    },
                    {
                        'field': 'assignValue',
                        'title':'<@spring.message "hap_extend.data_permission.rule.title_level_value"/>',
                        'width': 50,
                        template : function(dataItem){
                            if(dataItem && dataItem['assignValueName']){
                                return dataItem['assignValueName'];
                            }else if(dataItem && 'GLOBAL'==dataItem['assignType'] && dataItem['assignId']){
                                return assignValue_global.rows[0]["assignValueName"];
                            }
                            return '';
                        },
                        editor: function (container, options) {
                            $('<span class="k-textbox k-space-right" style="width: 100%;"><input readonly="readonly" type="text" name="' + options.field + '" class="k-input k-textbox"/><a href="#" id="grid_search_btn" class="k-icon k-i-search">&nbsp;</a></span>')
                                    .appendTo(container);
                            // 将这条数据设置为全局可见
                            window.parentData = $("#themeListGrid").data("kendoGrid").dataItem($(container).closest("tr"));
                            var rowData = window.parentData;
                            if(rowData && rowData['assignType']){
                                if('ROLE'==rowData['assignType']){
                                    levelGrid.setDataSource(roleDataSource);
                                    $("#levelWindow").data("kendoWindow").center().open();
                                }else if('USER'==rowData['assignType']){
                                    levelGrid.setDataSource(userDataSource);
                                    $("#levelWindow").data("kendoWindow").center().open();
                                }else if('GLOBAL'==rowData['assignType']){
                                    levelGrid.setDataSource(globalDataSource);
                                    $("#levelWindow").data("kendoWindow").center().open();
                                }
                            }
                        }
                    },
                    {
                        'field':'description',
                            'title':'描述',
                            'width':100
                    },
                    {
                        attributes: {style: "text-align:center;"},
                        'field': 'enableFlag',
                        'title':'<@spring.message "hap_extend.data_permission.rule.title_rule_enable"/>',
                        'width': 30
                    },
                    {
                        'field':'',
                        'title':'JS分配',
                        'width':30,
                        template:function (rowData) {
                            if(!!rowData.assignId){
                                var html = "<button  class='btn btn-warning'onclick='showAssignJsWin(\""
                                        + rowData.resourceId+"\",\""
                                        + rowData.assignId
                                        + "\")'"
//                                + "><@spring.message 'hap_extend.data_permission.rule.title_rule_dispatch_rule'/>"
                                        + ">JS分配"
                                        + "</button>";
                                return html;
                            }else{
//                                return "<button  class='btn btn-warning' disabled='disabled'><@spring.message 'hap_extend.data_permission.rule.title_rule_dispatch_rule'/></button>";
                                return "<button  class='btn btn-warning' disabled='disabled'>JS分配</button>";
                            }
                        }
                    },
                    {
                        attributes: {style: "text-align:center;padding:0px"},
                        title: '<@spring.message "hap_extend.data_permission.rule.title_operation"/>',
                        command : [{
                            name:'remove',
                            template : function (rowData) {
                                return '<a class="btn btn-danger k-grid-remove"><@spring.message "hap.delete"/></a>';
                            },
                            click: function(e){
                                var th = this;
                                e.preventDefault();
                                kendo.ui.showConfirmDialog({
                                    title:$l('hap.tip.info'),
                                    message: $l('hap.tip.delete_confirm')
                                }).done(function(event){
                                    if(event.button == 'OK'){
                                        var data = th.dataItem($(e.target).closest("tr"));
                                        th.dataSource.remove(data);
                                        th.dataSource.sync()
                                    }
                                })
                            }
                        }],
                        width:30
                    }
                ],
                editable: true
            });
            kendo.bind($('#theme-content'),viewModel);
        });

        function showAssignJsWin(resourceId_p,assignId_p) {
            $("#assignJsWin_divId").kendoWindow(
            {
                actions : ["Close" ],
                width : 600,
                height : 450,
                title : 'JS分配',
                visible : false,
                iframe : true,
                modal: true,
                content : 'assign_js.html?resourceId='
                + resourceId_p+"&assignId="+assignId_p
            }).data("kendoWindow").maximize().open();
        }
    </script>
</div>
</body>
</html>