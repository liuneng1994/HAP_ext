<#--
    * description: 页面组件管理界面
    * version: 1.0
    * -->
<#include "../include/header.html">
<body>
<div id="content-container">
    <div id="page-content">
        <div class="panel">
            <form class="form-horizontal">
                <div class="panel-body col-sm-offset-0">
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label style="width: 20%"><@spring.message "hap_extend.op_permission.name"/></label>
                            <input type="text" style="width:70%" data-bind="value:model.componentName">
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label style="width: 20%"><@spring.message "hap_extend.op_permission.description"/></label>
                            <input type="text" style="width:70%" data-bind="value:model.description">
                        </div>
                    </div>

                </div>
                <div class="panel-footer text-right">
                    <span class="btn btn-success" data-bind="click:queryFunction" type="submit"><@spring.message "hap.query"/></span>
                    <span class="btn btn-default" data-bind="click:resetFunction" type="button"><@spring.message "hap.reset"/></span>
                </div>
            </form>
        </div>
        <div class="panel">
            <div class="panel-body">
                <div style="clear:both">
                    <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                        <span class="btn btn-primary" data-bind="click:createFunction" style="float:left;margin-right:5px;"><@spring.message "hap.new"/></span>
                        <span class="btn btn-success" data-bind="click:saveFunction" style="float:left;margin-right:5px;"><@spring.message "hap.save"/></span>
                        <span class="btn btn-default" data-bind="click:cancelFunction" style="float:left;margin-right:5px;"><@spring.message "hap.cancel"/></span>
                    </div>
                    <div style="clear:both">
                        <div id="components_grid" style="clear:both"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var baseRuleUrl = "${base.contextPath}/hap_extend/operation_permission/cpn/";
    //获取传递过来的数据
    var resourceId_param = "${RequestParameters.resourceId_param}";

    var viewModel = kendo.observable({
        model:{componentName:'',description:'',resourceId:resourceId_param},
        createFunction: function(){
            $('#components_grid').data('kendoGrid').addRow();
        },
        saveFunction: function(){
            $('#components_grid').data('kendoGrid').saveChanges();
        },
        cancelFunction: function(e){
            $('#components_grid').data('kendoGrid').cancelChanges();
        },
        queryFunction: function(e) {
            $('#components_grid').data('kendoGrid').dataSource.read();
        },
        resetFunction: function (e) {
            var formData = viewModel.model.toJSON();
            for (var k in formData) {
                if(!(k === "resourceId")){
                    viewModel.model.set(k, null);
                }
            }
        }
    });
    kendo.bind($('#toolbar-btn'), viewModel);
    kendo.bind($('#page-content'),viewModel);

    //页面局部变量
    var thisRowData;

    //Grid行中的删除事件处理函数
    //参数：grid_div_id是kendoGrid那个div的id值;e:click事件
    function grid_del_btn_click(grid_div_id,e){
        e.preventDefault();
        kendo.ui.showConfirmDialog({
            title:$l('hap.tip.info'),
            message: $l('hap.tip.delete_confirm')
        }).done(function(event){
            if(event.button == 'OK'){
                var data = $("#"+grid_div_id).data("kendoGrid").dataItem($(e.target).closest("tr"));
                $("#"+grid_div_id).data("kendoGrid").dataSource.remove(data);
                $("#"+grid_div_id).data('kendoGrid').saveChanges();
            }
        });
    }
    $("#components_grid").kendoGrid({
        dataSource: new kendo.data.DataSource({
            transport: {
                read: {
                    url: baseRuleUrl+"query",
                    type: "POST",
                    dataType: "json"
                },
                update: {
                    url: baseRuleUrl + "update",
                    type : 'POST',
                    dataType: "json",
                    contentType:"application/json"
                },
                create: {
                    url: baseRuleUrl+'submit',
                    type : 'POST',
                    dataType: "json",
                    contentType:"application/json"
                },
                destroy:{
                    url: baseRuleUrl+'remove',
                    type : 'POST',
                    dataType: "json",
                    contentType:"application/json"
                },
                parameterMap: function(options, operation) {
                    //封装请求参数
                    if (operation !== "read" && options.models) {
                        return kendo.stringify(Hap.prepareSubmitParameter(options, operation));
                    } else if (operation === "read") {
                        return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                    }
                }
            },
            batch: true,
            serverPaging: true,
            pageSize: 10,
            schema: {
                data: 'rows',
                total: 'total',
                model: {
                    id: "componentId",
                    fields: {
                        resourceId:{type: 'number',defaultValue:resourceId_param},
                        componentName:{type: 'string',validation: { required: true }},
                        componentType:{type: 'string',validation: { required: true }},
                        level:{type: 'string',validation: { required: true },defaultValue:"GRID"},
                        htmlTagId:{type: 'string',validation: { required: true }},
                        description:{type: 'string'},
                        enableFlag:{defaultValue:'Y',checkedValue:'Y',uncheckedValue:'N',type: 'boolean'}
                    }
                }
            }
        }),
        resizable: true,
        selectable: "multiple",
        scrollable: true,
        editable  : true,
        pageable: {
            pageSizes: [10, 20, 50, 100],
            refresh: true,
            buttonCount: 10
        },
        columns: [
            {
                field: "level",
//                title: '<@spring.message "hap_extend.op_permission.grid_title.name"/>',
                title: '类别',
                width: 80
            },
            {
                field: "componentType",
//                title: '<@spring.message "hap_extend.op_permission.grid_title.name"/>',
                title: '具体类型',
                width: 80
            },
            {
                field: "componentName",
                title: '<@spring.message "hap_extend.op_permission.grid_title.name"/>',
                width: 80
            },
            {
                field: "htmlTagId",
//                title: '<@spring.message "hap_extend.op_permission.grid_title.description"/>',
                title: 'HTML标签id',
                width: 80
            },
            {
                field: "description",
                title: '<@spring.message "hap_extend.op_permission.grid_title.description"/>',
                width: 80
            },
            {
                attributes: {style: "text-align:center;"},
                'field': 'enableFlag',
                'title':'<@spring.message "hap_extend.data_permission.rule.title_rule_enable"/>',
                'width': 30
            },
            {
                attributes: {style: "text-align:center;padding:0px"},
                field : "",
                title : '<@spring.message "hap_extend.op_permission.grid_title.op"/>',
                width : 50,
                template: function (rowData) {
                    if(!!rowData["componentId"]){
                        parameter = "components_grid";
                        return '<a class="btn btn-danger" onclick="grid_del_btn_click(parameter,event)"><@spring.message "hap.delete"/></a>';
                    }
                    return '<a class="btn btn-danger" disabled="disabled"><@spring.message "hap.delete"/></a>';
                }
            }
        ]
    });

</script>
<div>
</body>
</html>