<#--
    * description: 页面组件管理界面
    * version: 1.0
    * -->
<#include "../include/header.html">
<body>
<div id="content-container">
    <div id="page-content">
        <div class="panel">
            <form class="form-horizontal">
                <div class="panel-body col-sm-offset-0">
                    <div class="col-sm-3 col-lg-3 col-md-3">
                        <div class="form-group">
                            <label class="col-sm-4 col-lg-4 col-md-4 control-label"><@spring.message "hap_extend.op_permission.name"/></label>
                            <div class="col-sm-8 col-lg-8 col-md-8">
                                <input type="text" style="width:100%" data-bind="value:model.componentName" class="k-textbox">
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-3 col-lg-3 col-md-3">
                        <div class="form-group">
                            <label class="col-sm-4 col-lg-4 col-md-4 control-label"><@spring.message "hap_extend.op_permission.description"/></label>
                            <div class="col-sm-8 col-lg-8 col-md-8">
                                <input type="text" style="width:100%" data-bind="value:model.description" class="k-textbox">
                            </div>
                        </div>
                    </div>

                </div>
                <div class="panel-footer text-right">
                    <span class="btn btn-success" data-bind="click:queryFunction" type="submit"><@spring.message "hap.query"/></span>
                    <span class="btn btn-default" data-bind="click:resetFunction" type="button"><@spring.message "hap.reset"/></span>
                </div>
            </form>
        </div>
        <div class="panel">
            <div class="panel-body">
                <div style="clear:both">
                    <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                        <span class="btn btn-primary" data-bind="click:createFunction" style="float:left;margin-right:5px;"><@spring.message "hap.new"/></span>
                        <span class="btn btn-success" data-bind="click:saveFunction" style="float:left;margin-right:5px;"><@spring.message "hap.save"/></span>
                        <span class="btn btn-default" data-bind="click:cancelFunction" style="float:left;margin-right:5px;"><@spring.message "hap.cancel"/></span>
                    </div>
                    <div style="clear:both">
                        <div id="components_grid" style="clear:both"></div>
                    </div>
                    <div id="maintainColumnWin_divId" style="clear:both"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var baseRuleUrl = "${base.contextPath}/hap_extend/operation_permission/cpn/";
    //获取传递过来的数据
    var resourceId_param = "${RequestParameters.resourceId_param}";

    var viewModel = kendo.observable({
        model:{componentName:'',description:'',resourceId:resourceId_param},
        createFunction: function(){
            $('#components_grid').data('kendoGrid').addRow();
        },
        saveFunction: function(){
            $('#components_grid').data('kendoGrid').saveChanges();
        },
        cancelFunction: function(e){
            $('#components_grid').data('kendoGrid').cancelChanges();
        },
        queryFunction: function(e) {
            $('#components_grid').data('kendoGrid').dataSource.read();
        },
        resetFunction: function (e) {
            var formData = viewModel.model.toJSON();
            for (var k in formData) {
                if(!(k === "resourceId")){
                    viewModel.model.set(k, null);
                }
            }
        }
    });
    kendo.bind($('#toolbar-btn'), viewModel);
    kendo.bind($('#page-content'),viewModel);

    //Grid行中的删除事件处理函数
    //参数：grid_div_id是kendoGrid那个div的id值;e:click事件
    function grid_del_btn_click(grid_div_id,e){
        e.preventDefault();
        kendo.ui.showConfirmDialog({
            title:$l('hap.tip.info'),
            message: $l('hap.tip.delete_confirm')
        }).done(function(event){
            if(event.button == 'OK'){
                var data = $("#"+grid_div_id).data("kendoGrid").dataItem($(e.target).closest("tr"));
                $("#"+grid_div_id).data("kendoGrid").dataSource.remove(data);
                $("#"+grid_div_id).data('kendoGrid').saveChanges();
            }
        });
    }


    var level_dataSource = [
        {"meaning": "GRID", "value": "GRID"},
        {"meaning": "FORM", "value": "FORM"}
    ];
    var htmlTagAttr_dataSource = [
        {"meaning": "ID", "value": "ID"},
        {"meaning": "OP_PMS_NAME", "value": "OP_PMS_NAME"}
    ];

    $("#components_grid").kendoGrid({
        dataSource: new kendo.data.DataSource({
            transport: {
                read: {
                    url: baseRuleUrl+"query",
                    type: "POST",
                    dataType: "json"
                },
                update: {
                    url: baseRuleUrl + "update",
                    type : 'POST',
                    dataType: "json",
                    contentType:"application/json"
                },
                create: {
                    url: baseRuleUrl+'submit',
                    type : 'POST',
                    dataType: "json",
                    contentType:"application/json"
                },
                destroy:{
                    url: baseRuleUrl+'remove',
                    type : 'POST',
                    dataType: "json",
                    contentType:"application/json"
                },
                parameterMap: function(options, operation) {
                    //封装请求参数
                    if (operation !== "read" && options.models) {
                        return kendo.stringify(Hap.prepareSubmitParameter(options, operation));
                    } else if (operation === "read") {
                        return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                    }
                }
            },
            batch: true,
            serverPaging: true,
            pageSize: 10,
            schema: {
                data: 'rows',
                total: 'total',
                model: {
                    id: "componentId",
                    fields: {
                        resourceId:{type: 'number',defaultValue:resourceId_param},
                        componentName:{type: 'string',validation: { required: true }},
                        componentType:{type: 'string',validation: { required: true,
                            componenttypevalidation: function (input) {
                                if (input.is("[name='componentType']") && input.val() != "") {
                                    input.attr("data-componenttypevalidation-msg", "需要以字母开头，由数字和字母构成");
                                    return /^[A-Za-z][A-Za-z0-9]*$/.test(input.val());
                                }
                                return true;
                            }
                        }, defaultValue:"grid"},
                        level:{type: 'string',validation: { required: true },defaultValue:"GRID"},
                        htmlTagAttr:{type: 'string',validation: { required: true },defaultValue:"ID"},
                        htmlTagAttrVal:{type: 'string',validation: { required: true,
                            htmltagattrvalvalidation: function (input) {
                                if (input.is("[name='htmlTagAttrVal']") && input.val() != "") {
                                    input.attr("data-htmltagattrvalvalidation-msg", "需要以字母开头，由字母、数字、下划线构成");
                                    return /^[A-Za-z_][A-Za-z0-9_]*$/.test(input.val());
                                }
                                return true;
                            }
                        }},
                        description:{type: 'string'},
                        enableFlag:{defaultValue:'Y',checkedValue:'Y',uncheckedValue:'N',type: 'boolean'}
                    }
                }
            }
        }),
        resizable: true,
        selectable: "multiple",
        scrollable: true,
        editable  : true,
        pageable: {
            pageSizes: [10, 20, 50, 100],
            refresh: true,
            buttonCount: 10
        },
        columns: [
            {
                field: "level",
                title: '<@spring.message "hap_extend.op_permission.grid_title.level"/>',
//                title: '类别',
                width: 80,
                template: function (dataItem) {
                    return Hap.getCodeMeaning(level_dataSource, dataItem.level)
                },
                editor: function (container, options) {
                    var rowData = options.model;
                    $('<input required name="' + options.field + '"/>')
                    .appendTo(container)
                    .kendoDropDownList({
                        dataTextField : "meaning",
                        dataValueField: "value",
                        dataSource    : level_dataSource,
                        change: function (e) {
                            var dataItem = this.dataItem(e.item);
                            if("GRID"==dataItem["value"]){
                                rowData.set("componentType","grid");
                            }
                        }
                    });
                }
            },
            {
                field: "componentType",
                title: '<@spring.message "hap_extend.op_permission.grid_title.component_type"/>',
//                title: '具体类型',
                width: 80
            },
            {
                field: "componentName",
                title: '<@spring.message "hap_extend.op_permission.grid_title.name"/>',
                width: 80
            },
            {
                field: "htmlTagAttr",
                title: '<@spring.message "hap_extend.op_permission.grid_title.html_tag_attr"/>',
//                title: 'HTML标签属性',
                width: 80,
                template: function (dataItem) {
                    return Hap.getCodeMeaning(htmlTagAttr_dataSource, dataItem.htmlTagAttr)
                },
                editor: function (container, options) {
                    $('<input required name="' + options.field + '"/>')
                    .appendTo(container)
                    .kendoDropDownList({
                        dataTextField : "meaning",
                        dataValueField: "value",
                        dataSource    : htmlTagAttr_dataSource
                    });
                }
            },
            {
                field: "htmlTagAttrVal",
                title: '<@spring.message "hap_extend.op_permission.grid_title.html_tag_attr_val"/>',
//                title: 'HTML标签属性值',
                width: 80
            },
            {
                field: "description",
                title: '<@spring.message "hap_extend.op_permission.grid_title.description"/>',
                width: 80
            },//TODO 列维护---对应于表格的情况
            {
                attributes: {style: "text-align:center;padding:0px"},
                'field': '',
                'title':'<@spring.message "hap_extend.data_permission.grid_title.column_maintain"/>',
                'width': 40,
                template: function (rowData) {
                    if(!!rowData["componentId"] && "grid"===rowData["componentType"]){
                        parameter_componentId = rowData["componentId"];
                        return '<a class="btn btn-success" onclick="showMaintainColumnWin(parameter_componentId)"><@spring.message "hap_extend.data_permission.grid_title.column_maintain"/></a>';
                    }
                    return '<a class="btn btn-success" disabled="disabled"><@spring.message "hap_extend.data_permission.grid_title.column_maintain"/></a>';
                }
            },
            {
                attributes: {style: "text-align:center;padding:0px"},
                field : "",
                title : '<@spring.message "hap_extend.op_permission.grid_title.op"/>',
                width : 40,
                template: function (rowData) {
                    if(!!rowData["componentId"]){
                        parameter = "components_grid";
                        return '<a class="btn btn-danger" onclick="grid_del_btn_click(parameter,event)"><@spring.message "hap.delete"/></a>';
                    }
                    return '<a class="btn btn-danger" disabled="disabled"><@spring.message "hap.delete"/></a>';
                }
            }
        ]
    });
    Hap.autoResizeGrid("#components_grid");


    function showMaintainColumnWin(param_componentId) {
        $("#maintainColumnWin_divId").kendoWindow(
            {
                actions : ["Close" ],
                width : 600,
                height : 450,
                title : '<@spring.message "hap_extend.data_permission.grid_title.column_maintain"/>',
                visible : false,
                iframe : true,
                modal: true,
                content : 'cpn_gridColumn_edit.html?componentId_param='
                + param_componentId
            }).data("kendoWindow").center().open();
    }
</script>
</body>
</html>