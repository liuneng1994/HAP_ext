<#--
    * description: 规则管理（js控制代码管理）界面
    * version: 1.0
    * -->
<#include "../include/header.html">
<body>
<div>
<div id="content-container">
    <div id="page-content">
        <div class="panel">
            <form class="form-horizontal">
                <div class="panel-body col-sm-offset-0">
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label style="width: 20%"><@spring.message "hap_extend.data_permission.rule.rule_name"/></label>
                            <input type="text" style="width:70%" data-bind="value:model.jsName">
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="form-group">
                            <label style="width: 20%"><@spring.message "hap_extend.data_permission.rule.rule_description"/></label>
                            <input type="text" style="width:70%" data-bind="value:model.description">
                        </div>
                    </div>

                </div>
                <div class="panel-footer text-right">
                    <span class="btn btn-success" data-bind="click:queryFunction" type="submit"><@spring.message "hap.query"/></span>
                    <span class="btn btn-default" data-bind="click:resetFunction" type="button"><@spring.message "hap.reset"/></span>
                </div>
            </form>
        </div>
        <div class="panel">
            <div class="panel-body">
                <div style="clear:both">
                    <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                        <span class="btn btn-primary" data-bind="click:createFunction" style="float:left;margin-right:5px;"><@spring.message "hap.new"/></span>
                        <span class="btn btn-success" data-bind="click:saveFunction" style="float:left;margin-right:5px;"><@spring.message "hap.save"/></span>
                        <span class="btn btn-default" data-bind="click:cancelFunction" style="float:left;margin-right:5px;"><@spring.message "hap.cancel"/></span>
                    </div>
                    <div style="clear:both">
                        <div id="rules_grid" style="clear:both"></div>
                    </div>
                    <!-- 编辑js代码弹出框 -->
                    <div id="jsEditorWin"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var baseRuleUrl = "${base.contextPath}/hap_extend/operation_permission/js/";
    //获取传递过来的数据
    var resourceId_param = "${RequestParameters.resourceId_param}";

    var jsWin,jsWinTemplate;
    $(document).ready(function () {
        <!--渲染js代码弹出框-->
        jsWin = $("#jsEditorWin").kendoWindow({
            width: "660px",
            height:"350px",
            resizable: true,
            modal: true,
            title: "JS Editor",
            actions: [
                "Pin",
                "Minimize",
                "Maximize",
                "Close"
            ],
            visible: false
        });
        jsWinTemplate = kendo.template($("#jsEditorWin_template").html());
    });

    var viewModel = kendo.observable({
        model:{jsName:'',description:'',resourceId:resourceId_param},
        createFunction: function(){
            $('#rules_grid').data('kendoGrid').addRow();
        },
        saveFunction: function(){
            $('#rules_grid').data('kendoGrid').saveChanges();
        },
        cancelFunction: function(e){
            $('#rules_grid').data('kendoGrid').cancelChanges();
        },
        queryFunction: function(e) {
            $('#rules_grid').data('kendoGrid').dataSource.read();
        },
        resetFunction: function (e) {
            var formData = viewModel.model.toJSON();
            for (var k in formData) {
                if(!(k === "resourceId")){
                    viewModel.model.set(k, null);
                }
            }
        }
    });
    kendo.bind($('#toolbar-btn'), viewModel);
    kendo.bind($('#page-content'),viewModel);

    //页面局部变量
    var thisRowData;

    //Grid行中的删除事件处理函数
    //参数：grid_div_id是kendoGrid那个div的id值;e:click事件
    function grid_del_btn_click(grid_div_id,e){
        e.preventDefault();
        kendo.ui.showConfirmDialog({
            title:$l('hap.tip.info'),
            message: $l('hap.tip.delete_confirm')
        }).done(function(event){
            if(event.button == 'OK'){
                var data = $("#"+grid_div_id).data("kendoGrid").dataItem($(e.target).closest("tr"));
                $("#"+grid_div_id).data("kendoGrid").dataSource.remove(data);
                $("#"+grid_div_id).data('kendoGrid').saveChanges();
            }
        });
    }
    $("#rules_grid").kendoGrid({
        dataSource: new kendo.data.DataSource({
            transport: {
                read: {
                    url: baseRuleUrl+"query",
                    type: "POST",
                    dataType: "json"
                },
                update: {
                    url: baseRuleUrl + "update",
                    type : 'POST',
                    dataType: "json",
                    contentType:"application/json"
                },
                create: {
                    url: baseRuleUrl+'submit',
                    type : 'POST',
                    dataType: "json",
                    contentType:"application/json"
                },
                destroy:{
                    url: baseRuleUrl+'remove',
                    type : 'POST',
                    dataType: "json",
                    contentType:"application/json"
                },
                parameterMap: function(options, operation) {
                    //封装请求参数
                    if (operation !== "read" && options.models) {
//                        $.each(options.models, function (i, r) {
//                            if (type == 'create'){
//                                r['resourceId'] = resourceId_param;
//                            }
//                        });
                        return kendo.stringify(Hap.prepareSubmitParameter(options, operation));
                    } else if (operation === "read") {
                        return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                    }
                }
            },
            batch: true,
            serverPaging: true,
            pageSize: 10,
            schema: {
                data: 'rows',
                total: 'total',
                model: {
                    id: "jsId",
                    fields: {
                        resourceId:{type: 'number',defaultValue:resourceId_param},
                        jsName:{type: 'string',validation: { required: true }},
                        description:{type: 'string'},
                        jsScript:{type: 'string'}
                    }
                }
            }
        }),
        resizable: true,
        selectable: "multiple",
        scrollable: true,
        editable  : true,
        pageable: {
            pageSizes: [10, 20, 50, 100],
            refresh: true,
            buttonCount: 10
        },
        columns: [
            {
                field: "jsName",
                title: '<@spring.message "hap_extend.op_permission.grid_title.name"/>',
                width: 80
            },
            {
                field: "description",
                title: '<@spring.message "hap_extend.op_permission.grid_title.description"/>',
                width: 80
            },
            {
                field: "jsScript",
                title: '<@spring.message "hap_extend.op_permission.grid_title.js_code"/>',
                width: 80,
                editor:jsCodeEditor,
                template:"#=jsScript#"
            },
            {
                attributes: {style: "text-align:center;padding:0px"},
                field : "",
                title : '<@spring.message "hap_extend.op_permission.grid_title.op"/>',
                width : 50,
                template: function (rowData) {
                    if(!!rowData["jsId"]){
                        parameter = "rules_grid";
                        return '<a class="btn btn-danger" onclick="grid_del_btn_click(parameter,event)"><@spring.message "hap.delete"/></a>';
                    }
                    return '<a class="btn btn-danger" disabled="disabled"><@spring.message "hap.delete"/></a>';
                }
            }
        ]
    });
    function jsCodeEditor(container, options) {
//        $('<span class="k-textbox k-space-right" style="width: 100%;"><input readonly type="text" name="' + options.field + '" class="k-input k-textbox"/><a href="#" onclick="showJsCodeEditDialog(event)" class="k-icon k-i-search">&nbsp;</a></span>')
//                .appendTo(container);
        $('<span class="k-textbox" style="width: 100%;" onclick="showJsCodeEditDialog(event)"><input readonly type="text" name="' + options.field + '" class="k-input k-textbox"/></span>')
                .appendTo(container);
    };

    function showJsCodeEditDialog(event_param) {
        thisRowData = $("#rules_grid").data("kendoGrid").dataItem($(event_param.target).closest("tr"));
        $("#jsEditorWin").data("kendoWindow").content(jsWinTemplate);
        $("#jsEditorWin").data("kendoWindow").center().open();
        if(!!thisRowData["jsScript"]){
            $("#jsTextarea").val(thisRowData["jsScript"]);
        }
        else {
            $("#jsTextarea").val("");
        }
    }


    //编辑窗口确认方法
    function saveJsCode() {
        thisRowData.set("jsScript",$("#jsTextarea").val());
        closeJsEditorWin();
    }
    function closeJsEditorWin() {
        $("#jsEditorWin").data("kendoWindow").close();
    }
</script>
<script type="text/x-kendo-template" id="jsEditorWin_template">
    <div>
        <textarea rows="20" cols="88" id="jsTextarea"></textarea>
        <br/>
        <button class="btn btn-success" onclick="saveJsCode()"><@spring.message "hap.ok"/></button>
        <button class="btn btn-success" onclick="closeJsEditorWin()"><@spring.message "hap.cancel"/></button>
    </div>
</script>
<div>
</body>
</html>