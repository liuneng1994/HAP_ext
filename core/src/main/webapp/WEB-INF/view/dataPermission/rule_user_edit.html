<#include "../include/header.html">
<body>
    <div>
        <div id="content-container">
            <div id="page-content">
                <div class="panel">
                    <form class="form-horizontal">
                        <div class="panel-body col-sm-offset-0">
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label style="width: 20%">规则名称</label>
                                    <input type="text" style="width: 70%" data-bind="value:model.ruleName">
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label style="width: 20%">用户名称</label>
                                    <input type="text" style="width:70%" data-bind="value:model.userName">
                                </div>
                            </div>
                        </div>
                        <div class="panel-footer text-right">
                            <span class="btn btn-success" data-bind="click:queryFunction" type="submit"><@spring.message "hap.query"/></span>
                            <span class="btn btn-default" data-bind="click:resetFunction" type="button"><@spring.message "hap.reset"/></span>
                        </div>
                    </form>
                </div>
                <div class="panel">
                    <div class="panel-body">
                        <div style="clear:both">
                            <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                                <span class="btn btn-primary" data-bind="click:createFunction" style="float:left;margin-right:5px;"><@spring.message "hap.new"/></span>
                                <span class="btn btn-success" data-bind="click:saveFunction" style="float:left;margin-right:5px;"><@spring.message "hap.save"/></span>
                                <span class="btn btn-default" data-bind="click:cancelFunction" style="float:left;margin-right:5px;"><@spring.message "hap.cancel"/></span>
                            </div>
                            <div style="clear:both">
                                <div id="rule_users_grid" style="clear:both"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            var baseRuleUrl = "${base.contextPath}/hap_extend/data_permission/rule_user/";
            var viewModel = kendo.observable({
                model:{ruleName:'',userName:''},
                createFunction: function(){
                    $('#rule_users_grid').data('kendoGrid').addRow();
                },
                saveFunction: function(){
                    $('#rule_users_grid').data('kendoGrid').saveChanges();
                },
                cancelFunction: function(e){
                    $('#rule_users_grid').data('kendoGrid').cancelChanges();
                },
                queryFunction: function(e) {
                    $('#rule_users_grid').data('kendoGrid').dataSource.read();
                },
                resetFunction: function (e) {
                    var formData = viewModel.model.toJSON();
                    for (var k in formData) {
                        viewModel.model.set(k, null);
                    }
                }
            });
            kendo.bind($('#toolbar-btn'), viewModel);
            kendo.bind($('#page-content'),viewModel);

            //Grid行中的删除事件处理函数
            //参数：grid_div_id是kendoGrid那个div的id值;e:click事件
            function grid_del_btn_click(grid_div_id,e){
                e.preventDefault();
                kendo.ui.showConfirmDialog({
                    title:$l('hap.tip.info'),
                    message: $l('hap.tip.delete_confirm')
                }).done(function(event){
                    if(event.button == 'OK'){
                        var data = $("#"+grid_div_id).data("kendoGrid").dataItem($(e.target).closest("tr"));
                        $("#"+grid_div_id).data("kendoGrid").dataSource.remove(data);
                        $("#"+grid_div_id).data('kendoGrid').saveChanges();
                    }
                });
            }
            $("#rule_users_grid").kendoGrid({
                dataSource: new kendo.data.DataSource({
                    transport: {
                        read: {
                            url: baseRuleUrl+"query",
                            type: "POST",
                            dataType: "json"
                        },
                        update: {
                            url: baseRuleUrl + "update",
                            type : 'POST',
                            dataType: "json",
                            contentType:"application/json"
                        },
                        create: {
                            url: baseRuleUrl+'submit',
                            type : 'POST',
                            dataType: "json",
                            contentType:"application/json"
                        },
                        destroy:{
                            url: baseRuleUrl+'remove',
                            type : 'POST',
                            dataType: "json",
                            contentType:"application/json"
                        },
                        parameterMap: function(options, operation) {
                            //封装请求参数
                            if (operation !== "read" && options.models) {
                                return kendo.stringify(Hap.prepareSubmitParameter(options, operation));
                            } else if (operation === "read") {
                                return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                            }
                        }
                    },
                    batch: true,
                    serverPaging: true,
                    serverSorting: true,
                    pageSize: 10,
                    schema: {
                        data: 'rows',
                        total: 'total',
                        model: {
                            id: "mapperId",
                            fields: {
                                userId:{type: 'int',validation: { required: true }},
                                ruleId:{type: 'int',validation: { required: true }},
                                isInclude:{defaultValue:'Y',checkedValue:'Y',uncheckedValue:'N',type: 'boolean'},
                                ruleName:{type: 'string',validation: { required: false }},
                                userName: {type: 'string',validation: { required: false }}
                            }
                        }
                    }
                }),
                resizable: true,
                selectable: "multiple",
                scrollable: true,
                editable  : true,
                pageable: {
                    pageSizes: [10, 20, 50, 100],
                    refresh: true,
                    buttonCount: 10
                },
                columns: [
                    {
                        field: "ruleId",
                        title: '规则',
                        width: 100,
                        template: function (dataItem) {
                            return dataItem['ruleName'] || ''
                        },
                        editor: function (container, options) {
                            $('<input name="' + options.field + '"/>')
                                    .appendTo(container)
                                    .kendoLov($.extend(<@lov "HAP_EXTEND_RULE_LOV"/>, {
                                textField: 'ruleName',
                                model: options.model
                            }));
                        }
                    },
                    {
                        field: "userId",
                        title: '用户',
                        width: 100,
                        template : function(dataItem){
                            if(dataItem && dataItem['userName']){
                                return dataItem['userName'];
                            }
                            return '';
                        },
                        editor: function (container, options) {
                            $('<input name="' + options.field + '"/>')
                                    .appendTo(container)
                                    .kendoLov($.extend(<@lov "user_lov"/>, {
                                textField: 'userName',
                                model: options.model
                            }));
                        }
                    },
                    {
                        attributes: {style: "text-align:center;"},
                        field: "isInclude",
                        title: '进入包含名单',
                        width: 30
                    },
                    {
                        attributes: {style: "text-align:center;padding:0px"},
                        field : "",
                        title : '操作',
                        width : 50,
                        template: function (rowData) {
                            parameter = "rule_users_grid";
                            return '<a class="btn btn-danger" onclick="grid_del_btn_click(parameter,event)"><@spring.message "hap.delete"/></a>';
                        }
                    }
                ]
            });
        </script>
    </div>
</body>
</html>