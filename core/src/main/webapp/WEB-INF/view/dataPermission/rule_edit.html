<#include "../include/header.html">
<body>
    <div>
        <div id="content-container">
            <div id="page-content">
                <div class="panel">
                    <form class="form-horizontal">
                        <div class="panel-body col-sm-offset-0">
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label style="width: 20%">规则名称</label>
                                    <input type="text" style="width: 70%" data-bind="value:model.ruleName">
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <div class="form-group">
                                    <label style="width: 20%">规则SQL</label>
                                    <input type="text" style="width:70%" data-bind="value:model.ruleSql">
                                </div>
                            </div>
                        </div>
                        <div class="panel-footer text-right">
                            <span class="btn btn-success" data-bind="click:queryFunction" type="submit"><@spring.message "hap.query"/></span>
                            <span class="btn btn-default" data-bind="click:resetFunction" type="button"><@spring.message "hap.reset"/></span>
                        </div>
                    </form>
                </div>
                <div class="panel">
                    <div class="panel-body">
                        <div style="clear:both">
                            <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                                <span class="btn btn-primary" data-bind="click:createFunction" style="float:left;margin-right:5px;"><@spring.message "hap.new"/></span>
                                <span class="btn btn-success" data-bind="click:saveFunction" style="float:left;margin-right:5px;"><@spring.message "hap.save"/></span>
                                <span class="btn btn-default" data-bind="click:cancelFunction" style="float:left;margin-right:5px;"><@spring.message "hap.cancel"/></span>
                            </div>
                            <div style="clear:both">
                                <div id="rules_grid" style="clear:both"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
<div>
<pre class="language-html">
<code class="language-html">
NOTICE:禁止在规则SQL片段中包含与其他规则SQL之间逻辑操作符(AND、OR等)，确保每个规则是一个可以组成合法条件的SQL片段
       如：AND 1=1为不合法规则定义，需要去掉"AND",改为：1=1;
       条件中可以使用#userId#和#roleId#，这两个字符串将在sql解析的时候替换为当前查询的用户id和角色id;
       支持在一个查询SQL上应用多个规则，规则之间是逻辑与的关系，应用的规则和原始查询语句中其他条件之间也是逻辑与的关系.
       包含型Y/排斥型N：对于包含型规则，在规则用户页面中设置并且选项“进入包含名单”<b>选择Y</b>的用户将<b>受这个规则的约束</b>，其他用户不受约束；
       对于排斥型，在规则用户页面中设置并且选项“进入包含名单”<b>选择N</b>的用户将<b>不受这个规则的约束</b>，其他用户受约束
</code>
</pre>
</div>
        <script>
            var baseRuleUrl = "${base.contextPath}/hap_extend/data_permission/rule/";
            var viewModel = kendo.observable({
                model:{ruleName:'',ruleSql:''},
                createFunction: function(){
                    $('#rules_grid').data('kendoGrid').addRow();
                },
                saveFunction: function(){
                    $('#rules_grid').data('kendoGrid').saveChanges();
                },
                cancelFunction: function(e){
                    $('#rules_grid').data('kendoGrid').cancelChanges();
                },
                queryFunction: function(e) {
                    $('#rules_grid').data('kendoGrid').dataSource.read();
                },
                resetFunction: function (e) {
                    var formData = viewModel.model.toJSON();
                    for (var k in formData) {
                        viewModel.model.set(k, null);
                    }
                }
            });
            kendo.bind($('#toolbar-btn'), viewModel);
            kendo.bind($('#page-content'),viewModel);

            //Grid行中的删除事件处理函数
            //参数：grid_div_id是kendoGrid那个div的id值;e:click事件
            function grid_del_btn_click(grid_div_id,e){
                e.preventDefault();
                kendo.ui.showConfirmDialog({
                    title:$l('hap.tip.info'),
                    message: $l('hap.tip.delete_confirm')
                }).done(function(event){
                    if(event.button == 'OK'){
                        var data = $("#"+grid_div_id).data("kendoGrid").dataItem($(e.target).closest("tr"));
                        $("#"+grid_div_id).data("kendoGrid").dataSource.remove(data);
                        $("#"+grid_div_id).data('kendoGrid').saveChanges();
                    }
                });
            }
            $("#rules_grid").kendoGrid({
                dataSource: new kendo.data.DataSource({
                    transport: {
                        read: {
                            url: baseRuleUrl+"query",
                            type: "POST",
                            dataType: "json"
                        },
                        update: {
                            url: baseRuleUrl + "update",
                            type : 'POST',
                            dataType: "json",
                            contentType:"application/json"
                        },
                        create: {
                            url: baseRuleUrl+'submit',
                            type : 'POST',
                            dataType: "json",
                            contentType:"application/json"
                        },
                        destroy:{
                            url: baseRuleUrl+'remove',
                            type : 'POST',
                            dataType: "json",
                            contentType:"application/json"
                        },
                        parameterMap: function(options, operation) {
                            //封装请求参数
                            if (operation !== "read" && options.models) {
                                return kendo.stringify(Hap.prepareSubmitParameter(options, operation));
                            } else if (operation === "read") {
                                return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                            }
                        }
                    },
                    batch: true,
                    serverPaging: true,
                    pageSize: 10,
                    schema: {
                        data: 'rows',
                        total: 'total',
                        model: {
                            id: "ruleId",
                            fields: {
                                ruleName:{type: 'string',validation: { required: true }},
                                isIncludeType:{defaultValue:'Y',checkedValue:'Y',uncheckedValue:'N',type: 'boolean'},
                                ruleSql: {type: 'string',validation: { required: true }}
                            }
                        }
                    }
                }),
                resizable: true,
//                    selectable: "multiple,rowbox",
                selectable: "multiple",
                scrollable: true,
                columnMenu: true,
                reorderable: true,
                editable  : true,
                pageable: {
                    pageSizes: [10, 20, 50, 100],
                    refresh: true,
                    buttonCount: 10
                },
                columns: [
                    {
                        field: "ruleName",
                        title: '规则名称',
                        width: 80
                    },
                    {
                        attributes: {style: "text-align:center;"},
                        field: "isIncludeType",
                        title: '包含型Y/排斥型N',
                        width: 50
                    },
                    {
                        field: "ruleSql",
                        title: '规则SQL',
                        width: 200
                    },
                    {
                        attributes: {style: "text-align:center;padding:0px"},
                        field : "",
                        title : '操作',
                        width : 50,
                        template: function (rowData) {
                            parameter = "rules_grid";
                            return '<a class="btn btn-danger" onclick="grid_del_btn_click(parameter,event)"><@spring.message "hap.delete"/></a>';
                        }
                    }
                ]
            });
        </script>
    </div>
</body>
</html>