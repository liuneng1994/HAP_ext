<#include "../include/header.html">
<body>
<div>
    <div id="content-container">
        <div id="page-content">
            <div class="panel">
                <form class="form-horizontal">
                    <div class="panel-body col-sm-offset-0">
                        <div class="col-sm-3 col-lg-3 col-md-3">
                            <div class="form-group">
                                <label class="col-sm-4 col-lg-4 col-md-4 control-label"><@spring.message "hap_extend.data_permission.mappermethod.sql_id"/></label>
                                <div class="col-sm-8 col-lg-8 col-md-8">
                                    <input type="text" style="width:100%" data-bind="value:model.sqlId" class="k-textbox">
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3 col-lg-3 col-md-3">
                            <div class="form-group">
                                <label class="col-sm-4 col-lg-4 col-md-4 control-label"><@spring.message "hap_extend.data_permission.mappermethod.description"/></label>
                                <div class="col-sm-8 col-lg-8 col-md-8">
                                    <input type="text" style="width:100%" data-bind="value:model.description" class="k-textbox">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-footer text-right">
                        <span class="btn btn-success" data-bind="click:queryFunction" type="submit"><@spring.message "hap.query"/></span>
                        <span class="btn btn-default" data-bind="click:resetFunction" type="button"><@spring.message "hap.reset"/></span>
                    </div>
                </form>
            </div>
            <div class="panel">
                <div class="panel-body">
                    <div style="clear:both">
                        <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                            <span class="btn btn-primary" data-bind="click:createFunction" style="float:left;margin-right:5px;"><@spring.message "hap.new"/></span>
                            <span class="btn btn-success" data-bind="click:saveFunction" style="float:left;margin-right:5px;"><@spring.message "hap.save"/></span>
                            <span class="btn btn-default" data-bind="click:cancelFunction" style="float:left;margin-right:5px;"><@spring.message "hap.cancel"/></span>
                        </div>
                        <div style="clear:both">
                            <div id="rules_grid" style="clear:both"></div>
                        </div>
                        <div id="dispatchRuleWindow"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        var baseRuleUrl = "${base.contextPath}/hap_extend/data_permission/method_rule_header/";
        var viewModel = kendo.observable({
            model:{sqlId:'',description:''},
            createFunction: function(){
                $('#rules_grid').data('kendoGrid').addRow();
            },
            saveFunction: function(){
                $('#rules_grid').data('kendoGrid').saveChanges();
            },
            cancelFunction: function(e){
                $('#rules_grid').data('kendoGrid').cancelChanges();
            },
            queryFunction: function(e) {
                $('#rules_grid').data('kendoGrid').dataSource.read();
            },
            resetFunction: function (e) {
                var formData = viewModel.model.toJSON();
                for (var k in formData) {
                    viewModel.model.set(k, null);
                }
            }
        });
        $("#rule_input").kendoLov(${lovProvider.getLov(base.contextPath, base.locale, "HAP_EXTEND_RULE_LOV")});
        kendo.bind($('#toolbar-btn'), viewModel);
        kendo.bind($('#page-content'),viewModel);

        //Grid行中的删除事件处理函数
        //参数：grid_div_id是kendoGrid那个div的id值;e:click事件
        function grid_del_btn_click(grid_div_id,e){
            e.preventDefault();
            kendo.ui.showConfirmDialog({
                title:$l('hap.tip.info'),
                message: $l('hap.tip.delete_confirm')
            }).done(function(event){
                if(event.button == 'OK'){
                    var data = $("#"+grid_div_id).data("kendoGrid").dataItem($(e.target).closest("tr"));
                    $("#"+grid_div_id).data("kendoGrid").dataSource.remove(data);
                    $("#"+grid_div_id).data('kendoGrid').saveChanges();
                }
            });
        }
        $("#rules_grid").kendoGrid({
            dataSource: new kendo.data.DataSource({
                transport: {
                    read: {
                        url: baseRuleUrl+"query",
                        type: "POST",
                        dataType: "json"
                    },
                    update: {
                        url: baseRuleUrl + "update",
                        type : 'POST',
                        dataType: "json",
                        contentType:"application/json"
                    },
                    create: {
                        url: baseRuleUrl+'submit',
                        type : 'POST',
                        dataType: "json",
                        contentType:"application/json"
                    },
                    destroy:{
                        url: baseRuleUrl+'remove',
                        type : 'POST',
                        dataType: "json",
                        contentType:"application/json"
                    },
                    parameterMap: function(options, operation) {
                        //封装请求参数
                        if (operation !== "read" && options.models) {
                            return kendo.stringify(Hap.prepareSubmitParameter(options, operation));
                        } else if (operation === "read") {
                            return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                        }
                    }
                },
                batch: true,
                serverPaging: true,
                pageSize: 10,
                schema: {
                    data: 'rows',
                    total: 'total',
                    model: {
                        id: "headerId",
                        fields: {
                            description:{type: 'string'},
                            sqlId: {type: 'string',validation: { required: true }}
                        }
                    }
                }
            }),
            resizable: true,
//                    selectable: "multiple,rowbox",
            selectable: "multiple",
            scrollable: true,
            columnMenu: true,
            reorderable: true,
            editable  : true,
            pageable: {
                pageSizes: [10, 20, 50, 100],
                refresh: true,
                buttonCount: 10
            },
            columns: [
                {
                    field: "sqlId",
                    title: '<@spring.message "hap_extend.data_permission.mappermethod.title_sql_id"/>',
                    width: 200
                },
                {
                    field: "description",
                    title: '<@spring.message "hap_extend.data_permission.mappermethod.title_description"/>',
                    width: 100
                },
                {
                    field: "",
                    title: '<@spring.message "hap_extend.data_permission.mappermethod.title_apply_rules"/>',
                    width: 50,
                    template : function(item) {
                        if(!!item.headerId){
                            var html = "<button  class='btn btn-info'onclick='showDispatchRuleToMethodWindow(\""
                                    + item.headerId
                                    + "\")'"
                                    + "><@spring.message 'hap_extend.data_permission.mappermethod.title_apply_rules'/>"
                                    + "</button>";
                            return html;
                        }else{
                            return "<button  class='btn btn-info' disabled='disabled'><@spring.message 'hap_extend.data_permission.mappermethod.title_apply_rules'/></button>";
                        }
                    }
                },
                {
                    attributes: {style: "text-align:center;padding:0px"},
                    field : "",
                    title : '<@spring.message "hap_extend.data_permission.rule.title_operation"/>',
                    width : 50,
                    template: function (rowData) {
                        parameter = "rules_grid";
                        return '<a class="btn btn-danger" onclick="grid_del_btn_click(parameter,event)"><@spring.message "hap.delete"/></a>';
                    }
                }
            ]
        });

        function showDispatchRuleToMethodWindow(headerIdStr) {
            $("#dispatchRuleWindow").kendoWindow(
                    {
                        actions : [ "Maximize", "Minimize", "Close" ],
                        width : 600,
                        height : 450,
                        title : '<@spring.message "hap_extend.data_permission.mappermethod.title_apply_rules"/>',
                        visible : false,
                        iframe : true,
                        modal: true,
                        content : 'assign_rule.html?headerId='
                        + headerIdStr
                    }).data("kendoWindow").center().open();
        }
    </script>
</div>
</body>
</html>