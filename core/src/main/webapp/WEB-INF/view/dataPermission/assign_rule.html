<#include "../include/header.html">
<#-- * description: 给SQL ID分配规则界面 * version: 1.0 *author:yazheng.yang@hand-china.com
    * #{copyright}# * -->
<body>
<div>
    <div id="content-container">
        <div id="theme-content">
            <div id="page-content" style="clear:both">
                <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
                    <span class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;" data-bind="click:createFunction"><@spring.message "hap.new"/></span>
                    <span class="btn btn-success"  style="float:left;margin-right:5px;" data-bind="click:saveFunction"><@spring.message "hap.save"/></span>
                    <span class="btn btn-default" data-bind="click:cancelFunction" style="float:left;margin-right:5px;"><@spring.message "hap.cancel"/></span>
                </div>
                <div style="clear:both">
                    <div id="themeListGrid" style="clear: both"></div>
                </div>
                <div id="levelWindow">
                    <div style="clear:both" >
                        <div id="levelGrid" style="clear:both"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="selectThemeDetails"></div>
    </div>
    <script type="text/javascript">
        var baseUrl = "${base.contextPath}/hap_extend/data_permission/method_rule_line/";
        var themes_data;
        //获取传递过来的数据
        var headerId = "${RequestParameters.headerId}";
        var viewModel = kendo.observable({
            model : {
                headerId:headerId
            },
            createFunction: function(){
                $('#themeListGrid').data('kendoGrid').addRow();
            },
            saveFunction: function(){
                $('#themeListGrid').data('kendoGrid').dataSource.sync();
            },
            cancelFunction: function(e){
                $('#themeListGrid').data('kendoGrid').cancelChanges();
            },
            queryFunction: function(e) {
                $('#themeListGrid').data('kendoGrid').dataSource.page(1);
            },
            resetForm : function(e) {
                var formData = viewModel.model.toJSON();
                for ( var k in formData) {
                    if(k==="ruleId"){
                        continue;
                    }else {
                        viewModel.model.set(k, null);
                    }
                }
            }
        });
        kendo.bind($('#toolbar-btn'), viewModel);

        $(document).ready(function () {
            themes_data = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: baseUrl+"query",
                        type: "POST",
                        dataType: "json"
                    },
                    update: {
                        url: baseUrl + "update",
                        type : 'POST',
                        dataType: "json",
                        contentType:"application/json"
                    },
                    create: {
                        url: baseUrl+'submit',
                        type : 'POST',
                        dataType: "json",
                        contentType:"application/json"
                    },
                    destroy:{
                        url: baseUrl+'remove',
                        type : 'POST',
                        dataType: "json",
                        contentType:"application/json"
                    },
                    parameterMap: function(options, operation) {
                        //封装请求参数
                        if (operation !== "read" && options.models) {
                            if(operation=='create'){
                                var datas = options.models;
                                $.each(datas, function (key, value) {
                                    value['headerId'] = viewModel.model.headerId;
                                });
                            }
                            return kendo.stringify(Hap.prepareSubmitParameter(options, operation));
                        } else if (operation === "read") {
                            return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                        }
                    }
                },
                batch: true,
                serverPaging : true,
                pageSize: 10,
                schema: {
                    data:'rows',
                    total:'total',
                    model: {
                        id: 'lineId',
                        fields: {
                            headerId: { type: 'int' },
                            ruleId: { type: 'int',validation: { required: true, nullable: false } },
                            enableFlag:{defaultValue:'Y',checkedValue:'Y',uncheckedValue:'N',type: 'boolean'},
                            ruleName: { type: 'string' },
                            sqlId: { type: 'string' }
                        }
                    }
                }
            });

            var grid = $("#themeListGrid").kendoGrid({
                dataSource: themes_data,
                resizable: true,
                selectable: "multiple",
                scrollable: true,
                columnMenu: true,
                reorderable: true,
                pageable: {
                    pageSizes: [10, 20, 50, 100],
                    refresh: true,
                    buttonCount: 10
                },
                columns:
                [
                    {
                        'field': 'ruleId',
                        'title':'<@spring.message "hap_extend.data_permission.mappermethod.rule"/>',
                        'width': 100,
                        template: function (dataItem) {
                            return dataItem['ruleName'] || ''
                        },
                        editor: function (container, options) {
                            $('<input name="' + options.field + '"/>')
                                    .appendTo(container)
                                    .kendoLov($.extend(<@lov "HAP_EXTEND_RULE_LOV"/>, {
                                textField: 'ruleName',
                                model: options.model
                            }));
                        }
                    },
                    {
                        attributes: {style: "text-align:center;"},
                        'field': 'enableFlag',
                        'title':'<@spring.message "hap_extend.data_permission.rule.title_rule_enable"/>',
                        'width': 30
                    },
                    {
                        attributes: {style: "text-align:center;padding:0px"},
                        title: '<@spring.message "hap_extend.data_permission.rule.title_operation"/>',
                        command : [{
                            name:'remove',
                            template : function (rowData) {
                                return '<a class="btn btn-danger k-grid-remove"><@spring.message "hap.delete"/></a>';
                            },
                            click: function(e){
                                var th = this;
                                e.preventDefault();
                                kendo.ui.showConfirmDialog({
                                    title:$l('hap.tip.info'),
                                    message: $l('hap.tip.delete_confirm')
                                }).done(function(event){
                                    if(event.button == 'OK'){
                                        var data = th.dataItem($(e.target).closest("tr"));
                                        th.dataSource.remove(data);
                                        th.dataSource.sync()
                                    }
                                })
                            }
                        }],
                        width:30
                    }
                ],
                editable: true
            });
            kendo.bind($('#theme-content'),viewModel);
        });

    </script>
</div>
</body>
</html>